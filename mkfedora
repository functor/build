#!/bin/bash
#
# Builds a Fedora Core reference image. Requires the build server to
# host a local yum repository in one of:
#
# /usr/share/mirrors/fedora
# /var/www/html/mirrors/fedora
#
# Otherwise, tries using CoBlitz:
#
# http://coblitz.planet-lab.org/pub/fedora
#
# Mark Huang <mlhuang@cs.princeton.edu>
# Copyright (C) 2004-2006 The Trustees of Princeton University
#
# $Id: mkfedora,v 1.20 2006/08/16 01:56:06 mlhuang Exp $
#

export PATH=/sbin:/bin:/usr/sbin:/usr/bin

# Verbosity
verbose=0

# Default yum repositories to try
mirrors=(
file:///data/fedora
http://coblitz.planet-lab.org/pub/fedora
ftp://mirror.cs.princeton.edu/pub/mirrors/fedora
ftp://mirror.stanford.edu/pub/mirrors/fedora
ftp://rpmfind.net/linux/fedora
)

# Release and architecture to install
releasever=4
basearch=i386

# Yum groups to install
groups=()

# Packages to install
packages=()

# Packages to exclude
exclude=()

# Exclude kernel* (and related) packages from all repositories except bootstrap
exclude_kernel=

# PlanetLab development environment
if [ -f /etc/planetlab/plc_config ] ; then
    . /etc/planetlab/plc_config
    if [ -n "$PLC_DEVEL_FEDORA_URL" ] ; then
	mirrors=($PLC_DEVEL_FEDORA_URL)
    fi
fi

usage()
{
    echo "Usage: mkfedora [OPTION]... [basedir]"
    echo "	-l url		Fedora mirror location. Defaults to try:"
    for mirror in "${mirrors[@]}" ; do
	echo "			$mirror"
    done
    echo "	-r release	Fedora release number (default: $releasever)"
    echo "	-a arch		Fedora architecture (default: $basearch)"
    echo "	-g group1 -g group2 ..."
    echo "			Yumgroups to install (default: none)"
    echo "	-p package1 -p package2 ..."
    echo "			Additional packages to install (default: none)"
    echo "	-x package1 -x package2 ..."
    echo "			Packages to exclude (default: none)"
    echo "	-k		Exclude kernel* packages from all repositories except bootstrap"
    echo "	-v		Be verbose"
    echo "	-h		This message"
    exit 1
}

# Get options
while getopts "l:r:a:g:p:x:kvh" opt ; do
    case $opt in
	l)
	    if echo $OPTARG | grep -q -i '^\(file\|http[s]*\)://' ; then
		mirrors=($OPTARG)
	    else
		mirrors=(file://$OPTARG)
	    fi
	    ;;
	r)
	    releasever=$OPTARG
	    ;;
	a)
	    basearch=$OPTARG
	    ;;
	g)
	    groups[${#groups[*]}]="$OPTARG"
	    ;;
	p)
	    packages[${#packages[*]}]="$OPTARG"
	    ;;
	x)
	    exclude[${#exclude[*]}]="$OPTARG"
	    ;;
	k)
	    exclude_kernel="exclude=kernel* ulogd iptables"
	    ;;
	v)
	    verbose=1
	    set -x
	    ;;
	h|*)
	    usage
	    ;;
    esac
done

shift $(($OPTIND - 1))
if [ ! -d "$1" ] ; then
    usage
fi

vroot=$(cd $1 && pwd -P)

if [ $UID -ne 0 ] ; then
    echo "Error: You must run this script as root."
    exit 1
fi

fetch ()
{
    curl --fail --silent --max-time 60 "$1"
}

for mirror in "${mirrors[@]}" ; do
    for baseurl in \
	$mirror/linux/core/$releasever/$basearch/os \
	$mirror/core/$releasever/$basearch/os \
	$mirror/$releasever/$basearch/os ; do
	if fetch $baseurl/repodata/repomd.xml >/dev/null ; then
	    break
	fi
	unset baseurl
    done
    if [ -n "$baseurl" ] ; then
	break
    fi
    unset baseurl
done

if [ -z "$baseurl" ] ; then
    echo "Error: $releasever/$basearch/os/repodata/repomd.xml"
    echo "       could not be found in any of the following locations:"
    echo
    for mirror in ${mirrors[@]} ; do
	echo $mirror/linux/core
	echo $mirror/core
	echo $mirror
    done
    echo
    usage
fi

exec 3>&1
exec 4>&2
if [ $verbose -eq 0 ] ; then
    exec 1>/dev/null
    exec 2>/dev/null
fi

# Minimally initialize /dev in reference image. If installed, the dev
# or udev RPMs will fill in the rest.
mkdir -p $vroot/dev
mknod -m 666 $vroot/dev/null c 1 3
mknod -m 666 $vroot/dev/zero c 1 5
mknod -m 666 $vroot/dev/full c 1 7
mknod -m 644 $vroot/dev/random c 1 8
mknod -m 644 $vroot/dev/urandom c 1 9
mknod -m 666 $vroot/dev/tty c 5 0
mknod -m 666 $vroot/dev/ptmx c 5 2
# For bash command substitution
ln -nsf ../proc/self/fd $vroot/dev/fd
# For df and linuxconf
touch $vroot/dev/hdv1
# For mkinitrd (in case a kernel is being installed)
for i in $(seq 0 7) ; do
    mknod -m 640 $vroot/dev/loop$i b 7 $i
done

# Do not tolerate errors
set -e

# Mount /dev/pts in reference image
mkdir -p $vroot/dev/pts
mount -t devpts none $vroot/dev/pts

# Mount /dev/shm in reference image
mkdir -p $vroot/dev/shm
mount -t tmpfs none $vroot/dev/shm

# Mount /proc in reference image
mkdir -p $vroot/proc
mount -t proc none $vroot/proc

cleanup ()
{
    umount $vroot/proc
    umount $vroot/dev/shm
    umount $vroot/dev/pts
}

# Clean up before exiting if anything goes wrong
trap "cleanup" ERR INT

# Create a dummy /etc/fstab in reference image
mkdir -p $vroot/etc
cat >$vroot/etc/fstab <<EOF
# This fake fstab exists only to please df and linuxconf.
/dev/hdv1	/	ext2	defaults	1 1
EOF
cp $vroot/etc/fstab $vroot/etc/mtab

# Prevent all locales from being installed in reference image
mkdir -p $vroot/etc/rpm
cat >$vroot/etc/rpm/macros <<EOF
%_install_langs en_US:en
%_excludedocs 1
%__file_context_path /dev/null
EOF

# Necessary for some scripts
mkdir -p $vroot/etc/sysconfig
echo "NETWORKING=yes" > $vroot/etc/sysconfig/network

# Trick rpm and yum, who read the real root /etc/rpm/macros file
# rather than the one installed in the reference image, despite what
# you might expect the --root and --installroot options to mean. Both
# programs always read $HOME/.rpmmacros.
export HOME=$vroot/tmp
mkdir -p $vroot/tmp
cp $vroot/etc/rpm/macros $vroot/tmp/.rpmmacros

# Initialize RPM database in reference image
mkdir -p $vroot/var/lib/rpm
rpm --root $vroot --initdb
rpm --root $vroot --import $baseurl/RPM-GPG-KEY-fedora

# Initialize yum in reference image
mkdir -p $vroot/var/cache/yum $vroot/var/log
cat >$vroot/etc/yum.conf <<EOF
[main]
cachedir=/var/cache/yum
debuglevel=2
logfile=/var/log/yum.log
pkgpolicy=newest
distroverpkg=redhat-release
tolerant=1
exactarch=1
retries=20
obsoletes=1
gpgcheck=0
# Prevent yum-2.4 from loading additional repository definitions
# (e.g., from /etc/yum.repos.d/)
reposdir=/dev/null

[base]
name=Fedora Core $releasever - $basearch - base
baseurl=$baseurl/
$exclude_kernel
EOF

for optional in updates extras ; do
    for optionalurl in \
	$mirror/linux/core/$optional/$releasever/$basearch \
	$mirror/core/$optional/$releasever/$basearch \
	$mirror/$optional/$releasever/$basearch ; do
        if fetch $optionalurl/repodata/repomd.xml ; then
	    cat >>$vroot/etc/yum.conf <<EOF

[$(basename $optional)]
name=Fedora Core $releasever - $basearch - $(basename $optional)
baseurl=$optionalurl/
$exclude_kernel
EOF
	    break
	fi
    done
done

# If we are being built as part of an automated RPM build, solve the
# bootstrap problem by including any just built packages in the yum
# configuration. This cooperates with the PlanetLab build system.
if [ -n "$RPM_BUILD_DIR" ] ; then
    RPM_RPMS_DIR=$(cd $(dirname $RPM_BUILD_DIR)/RPMS && pwd -P)
    # yum-2.0.x
    if [ -x /usr/bin/yum-arch ] ; then
	yum-arch $RPM_RPMS_DIR
    fi
    # yum-2.4.x
    if [ -x /usr/bin/createrepo ] ; then
	if [ -f $RPM_RPMS_DIR/yumgroups.xml ] ; then
	    groupfile="-g yumgroups.xml"
	fi
	createrepo $groupfile $RPM_RPMS_DIR
    fi
    # If run under sudo, allow user to delete the headers/ and
    # repodata/ directories.
    if [ -n "$SUDO_USER" ] ; then
	chown -R $SUDO_USER $RPM_RPMS_DIR
    fi
    cat >>$vroot/etc/yum.conf <<EOF

[bootstrap]
name=Bootstrap - $basearch - $RPM_RPMS_DIR/
baseurl=file://$RPM_RPMS_DIR/
EOF
fi

excludes=
for package in "${exclude[@]}" ; do
    excludes="$excludes --exclude=$package"
done

# glibc must be specified explicitly for the correct arch to be
# chosen.
echo "* Installing glibc" >&3
yum -c $vroot/etc/yum.conf --installroot=$vroot -y $excludes install glibc

# Go, baby, go
if [ ${#packages[*]} -gt 0 ] ; then
   echo "* Installing optional packages" "${packages[@]}" >&3
   yum -c $vroot/etc/yum.conf --installroot=$vroot -y $excludes \
	  install "${packages[@]}"
   if ! rpm --root $vroot -q "${packages[@]}" >/dev/null ; then
       echo "* Warning: Missing packages"
       rpm --root $vroot -q "${packages[@]}" | grep "not installed"
   fi
fi

if [ ${#groups[*]} -gt 0 ] ; then
   ## call yum sequentially to get finer-grained info on dependencies
   for grp in "${groups[@]}" ; do
      echo "* Installing optional group $grp" >&3
      yum -c $vroot/etc/yum.conf --installroot=$vroot -y $excludes \
	groupinstall "$grp"
   done
fi

# FC2 dev %preinstall checks /proc/mounts to make sure that /dev is
# not currently mounted as devfs. If it thinks it is, it will refuse
# to install the package. On a modern system running udev that mounts
# /dev as tmpfs, this check fails. Since we are installing into a
# chroot, whether /dev is mounted on the host system or not doesn't
# matter. If dev was explicitly mentioned in the packages list, force
# its installation.
if [ "$releasever" = "2" ] ; then
    for package in "${packages[@]}" ; do
	if [ "$package" = "dev" ] && ! rpm --root $vroot -q dev >/dev/null 2>&1 ; then
	    rpm --root $vroot -Uvh --noscripts $baseurl/Fedora/RPMS/dev-3.3.13-1.i386.rpm
	    break
	fi
    done
fi

# Clean yum cache
echo "* Cleaning up" >&3
yum -c $vroot/etc/yum.conf --installroot=$vroot -y \
    clean all

# Clean RPM state
rm -f $vroot/var/lib/rpm/__db*

# Set time zone to UTC
if [ -f $vroot/usr/share/zoneinfo/UTC -a -f $vroot/etc/localtime ] ; then
    rm -f $vroot/etc/localtime
    ln -s /usr/share/zoneinfo/UTC $vroot/etc/localtime
fi

# Clean up
cleanup

exit 0
